<script src="{{API_URL}}/htmx/htmx.min.js"></script>
<meta name="htmx-config" content='{"selfRequestsOnly": false}'>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
<link rel="stylesheet" href="{{API_URL}}/static/stamp.css"> 
<script type="module" src="{{API_URL}}/static/stamp.js"></script>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientific Data Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            prefix: 'tw-',
        }
    </script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    
    <!-- Scientific Data Card -->
    <div id='stamp-app' class="tw-preflight tw-text-[#1e1e1e] dark:tw-text-white tw-bg-white tw-shadow-2xl dark:tw-bg-[#1e1e1e] tw-rounded-[6px] tw-w-full tw-text-sm tw-max-w-4xl tw-mx-auto">
        
        <!-- Header -->
        <div class="tw-inline tw-mb-[5px]">
            <h1 class="tw-font-semibold tw-text-2xl tw-pt-[30px] tw-pl-[10px] tw-mb-[20px] dark:tw-text-white tw-text-black">Stamps</h1>
        </div>

        <!-- Primera Sección: Control de Fechas -->
        <div class="tw-flex tw-items-center tw-mb-[20px] tw-max-w-[95%] tw-m-auto tw-gap-4">
            
            <!-- Selector de Fechas -->
            <div class="tw-whitespace-nowrap">
                <p class="tw-text-black dark:tw-text-white tw-mb-1">Date:</p>
                <select id="dateSelector" class="tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-rounded tw-px-3 tw-py-2 tw-bg-white dark:tw-bg-[#1e1e1e] tw-text-black dark:tw-text-white tw-text-sm tw-min-w-[200px]">
                    {% for date in dates %}
                        <option value="{{loop.index0}}">{{date}}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Flechas de navegación -->
            <div class="tw-flex tw-gap-1 tw-mt-5">
                <button id="prevDate" class="tw-bg-white dark:tw-bg-[#1e1e1e] tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-w-8 tw-h-8 tw-flex tw-items-center tw-justify-center tw-cursor-pointer tw-rounded tw-transition-all tw-duration-200 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-text-black dark:tw-text-white" title="Fecha anterior">
                    ←
                </button>
                <button id="nextDate" class="tw-bg-white dark:tw-bg-[#1e1e1e] tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-w-8 tw-h-8 tw-flex tw-items-center tw-justify-center tw-cursor-pointer tw-rounded tw-transition-all tw-duration-200 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-text-black dark:tw-text-white" title="Fecha siguiente">
                    →
                </button>
            </div>
            
            <!-- Botón AVRO -->
            <button id="avroBtn" class="tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-4 tw-py-2 tw-rounded tw-text-sm tw-font-medium tw-transition-colors tw-mt-5 tw-ml-20">
                AVRO
            </button>
            
            <!-- Tooltip -->
            <div class="tw-relative tw-group tw-mt-5">
                <span class="tw-w-6 tw-h-6 tw-bg-gray-400 dark:tw-bg-gray-600 tw-text-white tw-rounded-full tw-text-xs tw-flex tw-items-center tw-justify-center tw-cursor-help">
                    <svg class="tw-w-3 tw-h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                    </svg>
                </span>
                <div class="tw-invisible group-hover:tw-visible tw-absolute tw-z-50 tw-bg-gray-800 dark:tw-bg-gray-900 tw-text-white tw-text-center tw-rounded-md tw-px-3 tw-py-2 tw-text-xs tw-whitespace-nowrap tw-opacity-0 group-hover:tw-opacity-100 tw-transition-opacity tw-duration-300 tw-pointer-events-none tw-bottom-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-mb-2">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore.
                    <div class="tw-absolute tw-top-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-w-0 tw-h-0 tw-border-l-4 tw-border-r-4 tw-border-t-4 tw-border-transparent tw-border-t-gray-800 dark:tw-border-t-gray-900"></div>
                </div>
            </div>
        </div>
        
        <!-- Segunda Sección: Imágenes -->
        <div class="tw-w-[95%] tw-mx-auto tw-mb-6">
            <div class="tw-grid tw-grid-cols-3 tw-gap-4 tw-mb-4">
                
                <!-- Science Image -->
                <div class="tw-flex tw-flex-col tw-items-center">
                    <div class="tw-mb-2">
                        <button onclick="downloadImage('science')" class="tw-w-full tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                            <svg class="tw-w-4 tw-h-4 tw-inline tw-mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            Science
                        </button>
                    </div>
                    <img id="scienceImg" src="" alt="Science" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
                </div>
                
                <!-- Template Image -->
                <div class="tw-flex tw-flex-col tw-items-center">
                    <div class="tw-mb-2">
                        <button onclick="downloadImage('template')" class="tw-w-full tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                            <svg class="tw-w-4 tw-h-4 tw-inline tw-mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            Template
                        </button>
                    </div>
                    <img id="templateImg" src="" alt="Template" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
                </div>
                
                <!-- Difference Image -->
                <div class="tw-flex tw-flex-col tw-items-center">
                    <div class="tw-mb-2">
                        <button onclick="downloadImage('difference')" class="tw-w-full tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                            <svg class="tw-w-4 tw-h-4 tw-inline tw-mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            Difference
                        </button>
                    </div>
                    <img id="differenceImg" src="" alt="Difference" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
                </div>
            </div>
            
            <!-- Controles de Imagen -->
            <div class="tw-flex tw-justify-center tw-gap-3 tw-mt-4">
                <button id="zoomBtn" class="tw-bg-white dark:tw-bg-[#1e1e1e] tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-text-black dark:tw-text-white tw-px-4 tw-py-2 tw-rounded tw-text-sm tw-font-medium hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-transition-colors">
                    <svg class="tw-w-4 tw-h-4 tw-inline tw-mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    Zoom
                </button>
                <button id="centerBtn" class="tw-bg-white dark:tw-bg-[#1e1e1e] tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-text-black dark:tw-text-white tw-px-4 tw-py-2 tw-rounded tw-text-sm tw-font-medium hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-transition-colors">
                    <svg class="tw-w-4 tw-h-4 tw-inline tw-mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                    </svg>
                    Center
                </button>
                <div class="tw-relative tw-group tw-mt-0.5">
                    <button class="tw-bg-gray-400 dark:tw-bg-gray-600 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-sm tw-font-medium">
                        <svg class="tw-w-4 tw-h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div class="tw-invisible group-hover:tw-visible tw-absolute tw-z-50 tw-bg-gray-800 dark:tw-bg-gray-900 tw-text-white tw-text-center tw-rounded-md tw-px-3 tw-py-2 tw-text-xs tw-whitespace-nowrap tw-opacity-0 group-hover:tw-opacity-100 tw-transition-opacity tw-duration-300 tw-pointer-events-none tw-bottom-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-mb-2">
                        Lorem ipsum dolor sit amet consectetur adipiscing elit
                        <div class="tw-absolute tw-top-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-w-0 tw-h-0 tw-border-l-4 tw-border-r-4 tw-border-t-4 tw-border-transparent tw-border-t-gray-800 dark:tw-border-t-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="tw-flex tw-justify-between tw-w-[95%] tw-mx-auto tw-font-roboto tw-pb-4">
            <p id="dummy-p"></p>
        </div>
    </div>
    
    <!-- Modal AVRO -->
    <div id="avroModal" class="tw-hidden tw-fixed tw-inset-0 tw-w-full tw-h-full tw-bg-black tw-bg-opacity-50 tw-z-50">
        <div class="tw-absolute tw-top-1/2 tw-left-1/2 tw-transform tw--translate-x-1/2 tw--translate-y-1/2 tw-bg-white dark:tw-bg-[#1e1e1e] tw-rounded-[6px] tw-p-5 tw-max-w-[90%] tw-max-h-[80%] tw-overflow-y-auto tw-shadow-2xl">
            <div class="tw-flex tw-justify-between tw-items-center tw-mb-4">
                <h2 class="tw-text-xl tw-font-bold tw-text-black dark:tw-text-white">Alert Information</h2>
                <button id="closeModal" class="tw-text-gray-500 dark:tw-text-gray-400 hover:tw-text-gray-700 dark:hover:tw-text-gray-200 tw-text-2xl tw-leading-none">×</button>
            </div>
            <p class="tw-text-gray-600 dark:tw-text-gray-300 tw-mb-4">For more information read the ZTF Schema.</p>
            <div class="tw-overflow-x-auto">
                <table class="tw-w-full tw-border-collapse">
                    <thead>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600">
                            <th class="tw-w-1/2 tw-p-2 tw-text-left tw-font-semibold tw-text-black dark:tw-text-white">Key</th>
                            <th class="tw-w-1/2 tw-p-2 tw-text-left tw-font-semibold tw-text-black dark:tw-text-white">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800">
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">aimage</td>
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">0.7599999904632568</td>
                        </tr>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800">
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">aimagerat</td>
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">0.3193277418613434</td>
                        </tr>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800">
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">bimage</td>
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">0.6710000038146973</td>
                        </tr>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800">
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">bimagerat</td>
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">0.2819327712059021</td>
                        </tr>
                        <tr class="tw-border-b-[1px] tw-border-b-solid tw-border-b-black dark:tw-border-b-gray-600 hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800">
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">candid</td>
                            <td class="tw-p-2 tw-break-words tw-text-black dark:tw-text-white">1450198835415015001</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script id="stamps-data" type="application/json">{{stamps | tojson}}</script>
    <script id="stamps-dates" type="application/json">{{dates | tojson}}</script>

    <script type="module">
        // Variables globales
        let currentDateIndex = 0;
        let zoomLevel = 1;
        let isZoomed = false;

        
        // Elementos del DOM
        const dateSelector = document.getElementById('dateSelector');
        const prevBtn = document.getElementById('prevDate');
        const nextBtn = document.getElementById('nextDate');
        const avroBtn = document.getElementById('avroBtn');
        const avroModal = document.getElementById('avroModal');
        const closeModal = document.getElementById('closeModal');
        const zoomBtn = document.getElementById('zoomBtn');
        const centerBtn = document.getElementById('centerBtn');
        const imagesByDate = JSON.parse(document.getElementById('stamps-data').textContent)
        const dates = JSON.parse(document.getElementById('stamps-dates').textContent)
        updateImages()
        
        // Funciones de navegación de fechas
        function updateImages() {
            const currentDate = dates[currentDateIndex];
            const images = imagesByDate[currentDateIndex][currentDate];
            // Actualizar las imágenes
            document.getElementById('scienceImg').src = images.science;
            document.getElementById('templateImg').src = images.template;
            document.getElementById('differenceImg').src = images.difference;
            
        }
        
        function updateDateSelector() {
            dateSelector.selectedIndex = currentDateIndex;
            updateImages(); // Actualizar imágenes cuando cambie la fecha
        }
        
        function goToPrevDate() {
            if (currentDateIndex > 0) {
                currentDateIndex--;
                updateDateSelector();
            }
        }
        
        function goToNextDate() {
            if (currentDateIndex < dates.length - 1) {
                currentDateIndex++;
                updateDateSelector();
            }
        }
        
        // Función de descarga de imágenes
        window.downloadImage = function(type) {
            const currentDate = dates[currentDateIndex];
            const imagePath = imagesByDate[currentDateIndex][currentDate][type];
            
            // Crear un enlace temporal para la descarga
            const link = document.createElement('a');
            
            // Usar la imagen real del diccionario
            link.href = imagePath;
            link.download = `${type}_${imagePath.split('/').pop().split('.')[0]}_${currentDate.replace(/[^a-zA-Z0-9]/g, '_')}.jpg`;
            
            // Simular clic para descargar
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        }
        
        // Función de zoom
        function toggleZoom() {
            const images = document.querySelectorAll('#scienceImg, #templateImg, #differenceImg');
            isZoomed = !isZoomed;
            
            const zoomIcon = zoomBtn.querySelector('svg');
            const zoomText = zoomBtn.childNodes[2]; // El texto después del SVG
            
            images.forEach(img => {
                if (isZoomed) {
                    img.style.transform = 'scale(1.5)';
                    zoomText.textContent = ' Zoom Out';
                } else {
                    img.style.transform = 'scale(1)';
                    zoomText.textContent = ' Zoom';
                }
            });
        }
        
        // Función para centrar imágenes
        function centerImages() {
            const images = document.querySelectorAll('#scienceImg, #templateImg, #differenceImg');
            images.forEach(img => {
                img.style.transform = 'scale(1) translate(0, 0)';
                img.style.transformOrigin = 'center center';
            });
            
            // Reset zoom state
            isZoomed = false;
            const zoomText = zoomBtn.childNodes[2];
            if (zoomText) zoomText.textContent = ' Zoom';
            
        }
        
        // Event listeners

        // Click en fechas de menu desplegable
        dateSelector.addEventListener('change', (e) => {
            currentDateIndex = parseInt(e.target.value);
            updateImages();
        });
        
        prevBtn.addEventListener('click', goToPrevDate);
        nextBtn.addEventListener('click', goToNextDate);
        
        // Modal AVRO
        avroBtn.addEventListener('click', () => {
            avroModal.classList.remove('tw-hidden');
        });
        
        closeModal.addEventListener('click', () => {
            avroModal.classList.add('tw-hidden');
        });
        
        // Cerrar modal al hacer clic fuera
        avroModal.addEventListener('click', (e) => {
            if (e.target === avroModal) {
                avroModal.classList.add('tw-hidden');
            }
        });
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !avroModal.classList.contains('tw-hidden')) {
                avroModal.classList.add('tw-hidden');
            }
        });
        
        // Controles de imagen
        zoomBtn.addEventListener('click', toggleZoom);
        centerBtn.addEventListener('click', centerImages);
        
        // Inicialización
        updateDateSelector();
        
    </script>


</body>
</html>