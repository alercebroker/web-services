<div class="tw-inline tw-mb-[5px]">
    <h1 class="tw-font-semibold tw-text-2xl tw-pt-[30px] tw-pl-[10px] tw-mb-[20px] dark:tw-text-white tw-text-black">Stamps</h1>
</div>

<div class="tw-flex tw-items-center tw-mb-[20px] tw-max-w-[95%] tw-m-auto tw-gap-4">
    
    <div class="tw-whitespace-nowrap">
        <p class="tw-text-black dark:tw-text-white tw-mb-1">Date:</p>
        <div class="tw-cursor-pointer">

          <button id="mid_arrow" class="tw-relative tw-cursor-pointer">
            
            <select 
                id="measurement_id" 
                name="measurement_id" 
                class="tw-appearance-none tw-cursor-pointer tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-rounded tw-pl-3 tw-pr-10 tw-py-2 tw-bg-white dark:hover:tw-bg-gray-800 dark:tw-bg-[#1e1e1e] dark:hover:tw-bg-gray-800 tw-cursor-pointer tw-text-black dark:tw-text-white tw-text-sm tw-min-w-[200px]"
                
                hx-on::config-request="event.detail.headers['Content-Type'] = 'application/json'"
                hx-post="{{ API_URL }}/htmx/update_stamp_card"
                hx-trigger="change"
                hx-target="#stamp-app"
                hx-swap="innerHTML"
                hx-ext="final-payload"
            >
                {% for detection in detections %}
                    <option class="tw-cursor-pointer" value="{{detection.measurement_id}}" 
                        {% if detection.measurement_id|string == selected_measurement_id|string %}
                            selected
                        {% endif %}
                    >{{detection.greg}}</option>
                {% endfor %}
            </select>

            <div id="mjd_arrow" class="tw-pointer-events-none tw-absolute tw-inset-y-0 tw-right-0 tw-flex tw-items-center tw-px-2">
                <svg name="arrow_icon" data-direction="down" class="tw-w-[24px] tw-h-[24px] tw-fill-current tw-text-black dark:tw-text-white" viewBox="0 -960 960 960">
                    <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                </svg>
            </div>

          </button>
        
        </div> 
    </div>

    <div class="tw-flex tw-gap-1 tw-mt-7">
        <button id="prevDate" 
            data-measurement-id="{{ prv_measurement_id }}"
            class="tw-w-8 tw-h-8 tw-flex tw-items-center tw-justify-center tw-rounded tw-transition-all tw-duration-200 tw-border
            {% if prv_measurement_id == selected_measurement_id %}
                tw-bg-gray-100 dark:tw-bg-gray-800 tw-text-gray-400 dark:tw-text-gray-600 tw-cursor-not-allowed tw-border-gray-200 dark:tw-border-gray-600
            {% else %}
                tw-bg-white dark:tw-bg-[#1e1e1e] tw-text-black dark:tw-text-white tw-cursor-pointer hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-border-gray-700 dark:tw-border-gray-300
            {% endif %}"
            
            {% if prv_measurement_id != selected_measurement_id %}
                hx-on::config-request="event.detail.headers['Content-Type'] = 'application/json'"
                hx-post="{{ API_URL }}/htmx/update_stamp_card"
                hx-trigger="click"
                hx-target="#stamp-app"
                hx-swap="innerHTML"
                hx-ext="final-payload"
            {% else %}
                disabled
            {% endif %}
            title="Previous date">
        ←
    </button>

    <button id="nextDate" 
            data-measurement-id="{{ nxt_measurement_id }}"
            class="tw-w-8 tw-h-8 tw-flex tw-items-center tw-justify-center tw-rounded tw-transition-all tw-duration-200 tw-border
            {% if nxt_measurement_id == selected_measurement_id %}
                tw-bg-gray-100 dark:tw-bg-gray-800 tw-text-gray-400 dark:tw-text-gray-600 tw-cursor-not-allowed tw-border-gray-200 dark:tw-border-gray-600
            {% else %}
                tw-bg-white dark:tw-bg-[#1e1e1e] tw-text-black dark:tw-text-white tw-cursor-pointer hover:tw-bg-gray-100 dark:hover:tw-bg-gray-800 tw-border-gray-700 dark:tw-border-gray-300
            {% endif %}"

            {% if nxt_measurement_id != selected_measurement_id %}
                hx-on::config-request="event.detail.headers['Content-Type'] = 'application/json'"
                hx-post="{{ API_URL }}/htmx/update_stamp_card"
                hx-trigger="click"
                hx-target="#stamp-app"
                hx-swap="innerHTML"
                hx-ext="final-payload"
            {% else %}
                disabled
            {% endif %}
            title="Next date">
        →
    </button>
    </div>
    
    {% if survey_id == "ztf" %}
    <button id="avroBtn" class="tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-4 tw-py-2 tw-rounded tw-text-sm tw-font-medium tw-transition-colors tw-mt-5 tw-ml-20">
        AVRO
    </button>
    {% endif %}
    {% if survey_id == "ztf" %}
    <div class="tw-relative tw-group tw-mt-5">
        <span class="tw-w-6 tw-h-6 tw-bg-gray-400 dark:tw-bg-gray-600 tw-text-white tw-rounded-full tw-text-xs tw-flex tw-items-center tw-justify-center tw-cursor-help">
            <svg class="tw-w-3 tw-h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
            </svg>
        </span>
        <div class="tw-invisible group-hover:tw-visible tw-absolute tw-z-50 tw-bg-gray-800 dark:tw-bg-gray-900 tw-text-white tw-text-center tw-rounded-md tw-px-3 tw-py-2 tw-text-xs tw-whitespace-nowrap tw-opacity-0 group-hover:tw-opacity-100 tw-transition-opacity tw-duration-300 tw-pointer-events-none tw-bottom-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-mb-2">
            Info...
            <div class="tw-absolute tw-top-full tw-left-1/2 tw-transform tw--translate-x-1/2 tw-w-0 tw-h-0 tw-border-l-4 tw-border-r-4 tw-border-t-4 tw-border-transparent tw-border-t-gray-800 dark:tw-border-t-gray-900"></div>
        </div>
    </div>
    {% endif %}
</div>

<div class="tw-w-[95%] tw-mx-auto tw-mb-6">
    <div id='stampsContainer' class="tw-grid tw-grid-cols-3 tw-gap-4 tw-mb-4">
        <div id="" class="tw-flex tw-flex-col tw-items-center">
            <div class="tw-mb-2">
                <button id="scienceDownload" content="{{oid}}_{{selected_measurement_id}}" class="tw-w-full tw-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                  <span> Science </span>
                  <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#e3e3e3">
                    <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                  </svg>
                </button>
            </div>
            <div id="scienceZoom" class="imageZoom crossHair tw-relative" style="
              --url: url('data:image/{{ science_mime }};base64, {{ science_img }}');
              --zoom-x: 0%; --zoom-y:0%;
              --display: none; --z-index: -1;
              ">
              <img id="scienceImg" src="data:image/{{ science_mime }};base64, {{ science_img }}" alt="Science" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
            </div>
        </div>
        
        <div class="tw-flex tw-flex-col tw-items-center">
            <div class="tw-mb-2">
                <button id="templateDownload" content="{{oid}}_{{selected_measurement_id}}" class="tw-w-full tw-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                  <span> Template </span>
                  <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#e3e3e3">
                    <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                  </svg>
                </button>
            </div>
            <div id="templateZoom" class="imageZoom crossHair tw-relative" style="
              --url: url('data:image/{{ template_mime }};base64, {{ template_img }}');
              --zoom-x: 0%; --zoom-y:0%;
              --display: none; --z-index: -1;
              ">
              <img id="templateImg" src="data:image/{{ template_mime }};base64, {{ template_img }}" alt="Template" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
            </div>
        </div>
        
        <div class="tw-flex tw-flex-col tw-items-center">
            <div class="tw-mb-2">
                <button id="differenceDownload" content="{{oid}}_{{selected_measurement_id}}" class="tw-w-full tw-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-px-3 tw-py-2 tw-rounded tw-text-xs tw-font-medium tw-transition-colors tw-border-b-[1px] tw-border-b-solid tw-border-b-blue-600">
                  <span> Difference </span>
                  <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#e3e3e3">
                    <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                  </svg>
                </button>
            </div>
            <div id="differenceZoom" class="imageZoom crossHair tw-relative" style="
              --url: url('data:image/{{ difference_mime }};base64, {{ difference_img }}');
              --zoom-x: 0%; --zoom-y:0%;
              --display: none; --z-index: -1;
              ">
              <img id="differenceImg" src="data:image/{{ difference_mime }};base64, {{ difference_img }}" alt="Difference" class="tw-transition-transform tw-duration-300 tw-ease-in-out tw-origin-center tw-max-w-full tw-h-auto tw-block tw-rounded">
            </div>
        </div>
    </div>
</div>

<div class="tw-w-[95%] tw-mx-auto tw-mb-6">
  <div class="tw-flex tw-justify-center tw-items-center tw-gap-4 tw-mb-4">
    <button id="zoomStamp" class= "tw-flex tw-col tw-items-center tw-cursor-pointer tw-w-[24px] tw-h-[24px]"> 
      <svg class='tw-fill-black dark:tw-fill-white' xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Zm-40-60v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z"/>
      </svg>
    </button>
    <button id="crossHairStamps" class="tw-flex tw-col tw-items-center tw-cursor-pointer tw-w-[24px] tw-h-[24px]"> 
      <svg class='tw-fill-black dark:tw-fill-white' xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
        <path d="M480-320q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm0-80q33 0 56.5-23.5T560-480q0-33-23.5-56.5T480-560q-33 0-56.5 23.5T400-480q0 33 23.5 56.5T480-400Zm0-80ZM200-120q-33 0-56.5-23.5T120-200v-160h80v160h160v80H200Zm400 0v-80h160v-160h80v160q0 33-23.5 56.5T760-120H600ZM120-600v-160q0-33 23.5-56.5T200-840h160v80H200v160h-80Zm640 0v-160H600v-80h160q33 0 56.5 23.5T840-760v160h-80Z"/>
      </svg> 
    </button>
    <div class="tw-relative tw-group tw-flex tw-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="tw-w-[20px] tw-h-[20px] tw-fill-black dark:tw-fill-white" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
        <path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/> 
      </svg>

      <div class="tw-absolute tw-right-[100%] tw-top-1/2
              tw-min-w-max tw-whitespace-nowrap
              tw-px-3 tw-py-2
              tw-bg-gray-900 tw-text-white tw-text-xs tw-rounded 
              tw-opacity-0 tw-invisible
              group-hover:tw-opacity-100 group-hover:tw-visible
              tw-transition-all tw-duration-300 tw-z-50 tw-pointer-events-none">
          
            Use the tool icons to change between zoom or crosshair modes.

          <div class="tw-absolute tw-right-[100%] tw-top-1/2 -tw-translate-y-1/2 
                  tw-border-4 tw-border-transparent tw-border-r-gray-900">
          </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import {init, downloadStamp} from "{{API_URL}}/static/stamp.js"

  init()
</script>
