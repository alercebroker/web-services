<div id="chart" style="width: 100%;height:100%;"></div>
<button id="toggle-theme-lc" class="tw-hidden"></button>
<script type="module">
import customDark from '{{API_URL}}/static/echarts-theme/customDark.js'
import {jdToGregorian, jdToDate} from '{{API_URL}}/static/AstroDates.js'
import {extractDate, extractTime, convertToDate,getUTCDate, formatDate} from '{{API_URL}}/static/time.js'


// Initialize the echarts instance and use the current system theme

var customDarkTheme = customDark()
var theme = document.getElementById('main-app').classList.contains('tw-dark') ? customDarkTheme : 'light'
var chartDom = document.getElementById('chart')
var myChart = echarts.init(chartDom, theme);
var options = {{ options | tojson }};
var toggleLcTheme = document.getElementById('toggle-theme-lc')

var tooltip_options = {
  "trigger" : "item",
  formatter: params => {
    const { seriesName, value, color } = params;
    var slide_index = () => {
      if (seriesName.includes('+') || seriesName.includes('*')) {
        return -5
      }

      return -1
    }
    
    var band = seriesName.includes('DR') ?  seriesName.slice(slide_index()) + ' ' +'DR' : seriesName.slice(slide_index())
    var plot_value = value[1].toFixed(3)
    var plot_error = value[5].toFixed(3)
    var plot_value_sign = plot_value < 0 ? "(-)" : "(+)"
    var plot_value_text = plot_value_sign + " " + `${plot_value}`+ ' Â± '  + `${plot_error}`;

    var measurement_id = value[2]
    var MJD = value[0]
    var utcDate = jdToDate(MJD).toUTCString().slice(0, -3) + "UTC";

    var DR_object_id = value[3]
    var DR_field = value[4]

    var createTableHtml = () => {
      var table_div = document.createElement('div')
      var row_measurement_id = createRowItem('Measurement id', measurement_id)
      var row_value = createRowItem(band, plot_value_text)
      var row_mjd = createRowItem('MJD', MJD)
      var row_UTC = createRowItem('Date', utcDate)
      var row_DR_id = createRowItem('objectid', DR_object_id)
      var row_DR_field = createRowItem('field', DR_field)

      table_div.setAttribute('style', 'min-width: 340px; padding: 0 16px;');

      if (measurement_id != null) {
        table_div.appendChild(row_measurement_id)
      }
      
      if (DR_object_id != null) {
        table_div.appendChild(row_DR_id)
      }

      if (DR_field != null) {
        table_div.appendChild(row_DR_field)
      }

      table_div.appendChild(row_value)
      table_div.appendChild(row_mjd)
      table_div.appendChild(row_UTC)


      return table_div
    }


    var createRowItem = (name, value) => {

      var row = document.createElement('div')
      row.setAttribute('style', 'display: flex; flex-direction: row; justify-content: flex-start; gap: 16px; font-size:13px; width: 100%; margin: 8px 0');

      var band_div = document.createElement('div')
      band_div.setAttribute('style', 'width: 40%;');
      band_div.innerHTML = name + " : "

      var band_value = document.createElement('div')
      band_value.setAttribute('style', 'width: 60%; font-weight: bold');
      band_value.innerText = value


      row.appendChild(band_div)
      row.appendChild(band_value)


      return row
    }

    return createTableHtml()
  }
}

options.tooltip = tooltip_options

// Make chart responsive
var plotGrid = document.getElementById('plot-grid');
var resizeObserver = new ResizeObserver(_ => {
  myChart.resize();
});
resizeObserver.observe(plotGrid);

// Dynamic theme switching. This detects system theme changes and updates the chart accordingly.
toggleLcTheme.addEventListener('click', () => {
  var themeMode = document.getElementById('main-app').classList.contains('tw-dark') ? customDarkTheme : 'light'
  myChart.clear()
  myChart.dispose();
  myChart = echarts.init(document.getElementById('chart'), themeMode);
  myChart.setOption(options);

})

// Display the chart using the configuration items and data just specified.
myChart.setOption(options);

</script>
