<script id="htmx-script" src="https://unpkg.com/htmx.org@1.9.11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{{API_URL}}/static/probability.css">

<div id="probabilities-app" class="tw-preflight tw-w-full tw-bg-white dark:tw-bg-[#1e1e1e]">
    <div class="tw-flex tw-flex-col tw-items-center tw-rounded-[6px]">

        <div id="selectContainer" class="tw-flex tw-justify-center tw-my-4 tw-mx-auto tw-w-full">
            <select name="selectClassifier" id="selectClassifier" class="tw-w-[50%] hover:tw-bg-[#757575] tw-bg-transparent tw-border-b tw-border-b-[#1e1e1e] dark:tw-border-b-white">
                <optgroup class="tw-bg-white dark:tw-bg-[#1e1e1e] dark:tw-text-white">
                    <option value="#" class="tw-hidden"></option>
                    <option value="lc_classifier">lc_classifier</option>
                    <option value="lc_classifier_top">lc_classifier_top</option>
                    <option value="stamp_classifier">stamp_classifier</option>
                </optgroup>
            </select>
        </div>

        <div class="md:tw-w-[50%] md:tw-h-[50%] sm:tw-w-[10%] sm:tw-h-[10%] tw-mx-auto tw-relative">
            <canvas id="myChart"></canvas>
        </div>

    </div>
</div>

<script type="module">
    const raw_db = {{prob_dict | tojson}};
    const raw_tax = {{taxonomy_dict | tojson}};
    const raw_group_prob_dict = {{ group_prob_dict | tojson }}
    const ctx = document.getElementById('myChart');


    let select = document.getElementById('selectClassifier')
    let mychart
    let probability_data_aux

    let tags_mapping = {
        "lc_classifier": ['SNIa','Periodic-Other', 'CEP', 'RRL', 'DSCT', 'E', 'LPV', 'YSO', 'CV/Nova', 'Blazar', 'AGN', 'QSO', 'SLSN', 'SNII', 'SNIbc'],
        "lc_classifier_top": ['Transient','Periodic','Stochastic'],
        "stamp_classifier": ['SN', 'bogus','asteroid','VS','AGN']
    }

    let data = {
        labels: [],
        datasets: [{
            label: 'Probabilities',
            data: [],
            fill: true,
            backgroundColor: 'rgba(255, 0, 54, 0.7)',
            borderColor: 'rgb(255, 0, 54)',
            pointBackgroundColor: 'rgb(255, 0, 54)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(255, 0, 54)',
        }]
    };


    let config = {
        type: 'radar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                line: {
                    borderWidth: 1,
                    fill: true,
                },
            },
            scales: {
                r: {
                    backgroundColor: 'white',
                    ticks: {
                        display: false,
                        maxTicksLimit: 5,
                    },
                    angleLines: {
                        color: '#000000'
                    },
                    grid: {
                        color: '#000000',
                    },
                    pointLabels: {
                        color: '#000000'
                    }
                },
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    mode: 'dataset',
                    position: 'nearest',
                    callbacks: {
                        title: function(){
                            return "Probability"
                        },
                        label: function(context){
                            let tooltipslabels = []
                            let label = ""
                            label = context.label + ": " + context.parsed.r
                            tooltipslabels.push(label)
                            return tooltipslabels
                        }
                    }
                }
            },
        }
    }

    init()

    function init(){
        probability_data_aux = []

        mychart = new Chart(ctx, config);
        console.log(raw_group_prob_dict)
        select.addEventListener('change', (e) => {
            updateMyChart(e.target.value)
        })
    }

    function orderDataByTagNew(classifier_name, labels_tags){
        probability_data_aux.length = 0
        
        labels_tags.forEach((e) => {
            raw_group_prob_dict[classifier_name].forEach((element) => {
                if(element.class_name == e){
                    probability_data_aux.push(element.probability)
                }
            })
        })
    }

    function updateMyChart(classifier_name){
        if(classifier_name in tags_mapping) {
            orderDataByTagNew(classifier_name, tags_mapping[classifier_name])

            removeDataChart()
            updateDataChart(tags_mapping[classifier_name])
            isDark();
        }
    }

    function removeDataChart(){
        mychart.data.labels.length=0;
        mychart.data.datasets.forEach((dataset) => {
            dataset.data.length=0;

        });
        mychart.update();
    }

    function updateDataChart(labels){
        mychart.data.labels.push(...labels);
        mychart.data.datasets.forEach((dataset) => {
            dataset.data.push(...probability_data_aux);
        });
        mychart.update();
    }

    function isDark(){
        if(document.getElementById("probabilities-app").classList.contains("tw-dark")){
            mychart.config.options.scales.r.backgroundColor = '#BDBDBD'
            mychart.config.options.scales.r.angleLines.color = '#EEEEEE'
            mychart.config.options.scales.r.grid.color = '#EEEEEE'
            mychart.config.options.scales.r.pointLabels.color = '#EEEEEE'
            
            mychart.update();
        }
    }
</script>